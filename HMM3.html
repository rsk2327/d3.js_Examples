<html style="width:100%;"">
<head>
<title>HMM</title>
<script type="text/javascript" src = "d3.min.js"></script>
<script type="text/javascript" src = "helperFunctions.js"></script>
<style  type = "text/css">
//@import 'https://fonts.googleapis.com/css?family=Oswald';
.active {
  stroke: #000;
  stroke-width: 2px;
}
.links line {
  stroke: #aaa;
}
.nodes circle {
  pointer-events: all;
  stroke: none;
  stroke-width: 40px;
}
.d3-tip {
  position: absolute;
  text-align: center;
  width: 60px;
  height: 28px;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  
  
  table {
    
    border-collapse: collapse;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translateX(-50%) translateY(-50%);
}
th, td {
    text-align: center;
	padding : 5px 10px 5px 10px;
	
	
}
td {
    
	 width : 100;
}
#divBox{
padding : 200px;
}
}
</style>
</head>
<body style="width:100%;margin-top:0px;margin-left:0px;margin-right:0px">
<script>
	
	var stateData = [{"id":0,"name":"Sunny",x:0,y:0},
                {"id":1,"name":"Rainy",x:0,y:0},
                {"id":2,"name":"Spring",x:0,y:0},
                {"id":3,"name":"June",x:0,y:0},
                {"id":4,"name":"Winter",x:0,y:0}];
	var obsData = [{'name':"Umbrella",'id':0,x:0,y:0},
                  {'name':"No Umbrella",'id':1,x:0,y:0},
                  {'name':"Coat",'id':2,x:0,y:0}];
				  

	var obsSeq = [0,1,2,1,2,1],
		obsLength = obsSeq.length;
	
	var stateHeight = 0.25,numStates  =stateData.length,numObs = obsData.length,
      obsHeight = 0.5,selected = 0,splitRatio = 30;
	  
	var emissionMat = [],transitionMat=[];
	
	for(i=0;i<numStates;i++)
	{
		emissionMat.push([]);
		for(j=0;j<numObs;j++)
		{	
			emissionMat[i].push(1.0/numObs);
		}
	}
	
	for(i=0;i<numStates;i++)
	{
		transitionMat.push([]);
		for(j=0;j<numStates;j++)
		{	
			transitionMat[i].push(1.0/numStates);
		}
	}
 
//// Header 	  
  var header = d3.select("body").append("svg").attr("height","5%").attr("width","100%").attr("margin-left",0);
  
  header.append("rect").attr("width","100%").attr("height","100%").attr("fill","orange");
  header.append("text").text("HMM").attr("fill","white").attr("x",function(d){ return header.select("rect").node().getBBox().x + 15; })
  .attr("y", function(d){ return header.select("rect").node().getBBox().height/2;});
  
  
//// Summary & Plot 
  var summary = d3.select("body").append("svg").attr("width",splitRatio+"%").attr("height","70%")
                  .attr("id","summary").attr("align","left").style("background","white");
  var plot = d3.select("body").append("svg").attr("width",(100-splitRatio)+"%").attr("height","70%").attr("id","plot").attr("align","right");
  
  plot.append("rect").attr("width","100%").attr("height","100%").attr("fill","white")
  .on("click","mouseSVGClick");
  
  var summaryWidth = document.getElementById("summary").getBoundingClientRect().width,
	  plotWidth = document.getElementById("plot").getBoundingClientRect().width,
	  plotHeight = document.getElementById("plot").getBoundingClientRect().height,
	  summaryHeight = document.getElementById("summary").getBoundingClientRect().height;
  
  summary.append("text").attr("x",summaryWidth*0.5).attr('y',0.07*summaryHeight).attr("text-anchor","middle").attr("fill","black").text("EMISSION PROBABILITIES");
  summary.append('foreignObject').attr("x",0).attr("y","10%").append("xhtml:body").attr("id","emissionBox").attr("margin-left",0);
  
  summary.append("text").attr("x",summaryWidth*0.5).attr("y",0.57*summaryHeight).attr("text-anchor","middle").attr("fill","black").text("TRANSITION PROBABILITIES");
  summary.append('foreignObject').attr("x",0).attr("y","60%").append("xhtml:body").attr("id","transitionBox");

//// Footer  		
var footer = d3.select("body").append("svg").attr("width","100%")
                .attr("height","25%").attr("id","footer").attr("margin-left",0);
footer.append('foreignObject').attr("x",summaryWidth).attr("y",0).append("xhtml:body").attr("id","footerBox");
	
//// Text
var descrip = d3.select("body").append("svg").attr("width","100%")
        				.attr("height","100%").attr("id","footer").attr("margin-left",0); 
descrip.append("rect").attr("width","100%").attr("height","100%").attr("fill","orange");
  
  
//Creating sequence table
createTable(numStates,obsLength,containerName='footerBox',tableName = "seqTable",width=plotWidth,
  height=document.getElementById("footer").getBoundingClientRect().height,"seq");
cleanTable("seqTable","seq");

//Creating emission table
createTable2(numStates,numObs,'emissionBox',"emissionTable",summaryWidth*0.8,height=summaryHeight*0.4,"em",data=emissionMat);
cleanTable("emissionTable","em");

 //Creating transition probabilities
createTable2(numStates,numStates,'transitionBox',"transitionTable",summaryWidth*0.8,height=summaryHeight*0.4,"trans",data=transitionMat);
cleanTable("transitionTable","trans");

var seqTable = document.getElementById("seqTable"), emissionTable = document.getElementById("emissionTable"),
	transitionTable = document.getElementById("transitionTable");

//HMM plot
getCenter2("states");
getCenter2("obs");

var stateLinks=[],
	obsLinks=[];
for(i=0;i<numStates;i++)
{
    for(j=0;j<numStates;j++)
    {
      stateLinks.push({source:i,target:j,id:"state"+i+j});
    }
}
for(i=0;i<numStates;i++)
{
   for(j=0;j<numObs;j++)
   {
      obsLinks.push({source:i,target:j,id:"obs"+i+j});
   }
}

// Adding links
plot.selectAll().data(stateLinks)
  .enter().append("path").attr("stroke","black").attr("stroke-width",0.5)
  .attr("fill-opacity",0.0).attr("d",positionLink).attr("id",function(d){ return d.id;});
  
plot.selectAll().data(obsLinks).enter().append("line").attr("x1",function(d){ return stateData[d.source].x ;}).attr("y1",function(d){ return stateData[d.source].y ;})
  .attr("x2",function(d){ return obsData[d.target].x ;}).attr("y2",function(d){ return obsData[d.target].y ;}).attr("stroke","black").attr("stroke-width",0.5).attr("stroke-dasharray","5,5")
  .attr("id",function(d){ return d.id;});

 //Adding node circles
plot.selectAll("circle").data(stateData).enter().append("circle").attr("r",20).attr("cx",function(d){ return d.x;}).attr("cy",function(d){ return d.y;})
  .attr("id", function(d,i){ return "state"+i;}).attr("fill","white").attr("stroke-width",3).attr("stroke","black")
  .call(d3.drag()
    .on("start",dragStart_S)
    .on("drag",dragged_S)
    .on("end", dragEnd_S))
  .on("mouseenter",mouseoverCircle)
  .on("mouseleave",mouseoutCircle)
  .on("click",mouseCircleClick);
  
plot.selectAll().data(obsData).enter().append("circle").attr("r",20).attr("cx",function(d){ return d.x;}).attr("cy",function(d){ return d.y;})
  .attr("id", function(d,i){ return "obs"+i;})
  .call(d3.drag()
    .on("start",dragStart_O)
    .on("drag",dragged_O)
    .on("end", dragEnd_O))
  .on("mouseenter",mouseoverCircle)
  .on("mouseleave",mouseoutCircle)
  .on("click",mouseCircleClick);

var tip = plot.append("g").attr("id","tip").attr("opacity",0.0);
tip.selectAll("rect").data([1]).enter().append("rect").attr("width",60).attr("height",40)
    .attr("x",0).attr("y",0).attr("fill","black").attr("opacity",0.7);
tip.selectAll("text").data([1]).enter().append("text").text("outside").attr("font-size",10).attr("fill","white").attr("x",10).attr("y",20).attr("text-anchor","middle");

function selectTextGen(id)
  {
    if(id.indexOf("state")!=-1)
    {
    //State node
    var text='',
        stateID = id[5];
    for(i=0;i<numStates;i++)
    {
      text = text + "#state"+stateID+i+",";
    }
    for(i=0;i<numObs-1;i++)
    {
      text = text + "#obs"+stateID+i+",";
    }
    text = text + "#obs"+stateID+(numObs-1);
    return text;
    }else
    {
    //Obs node
    }
}

function generateText(selector)
  {
      var text = [];
      text.push("STATES");
      // text.push("------------");
      for(var i =0;i<numStates;i++)
      {
        text.push("S"+i+" : "+stateData[i].name);
      }

      
      text.push("");
      text.push("OBSERVATIONS");
      
      for(var i =0;i<numObs;i++)
      {
        text.push("O"+i+" : "+obsData[i].name);
      }
      return text;
  }



  function getCenter(selector)
  {
    var width = svg.node().getBBox().width,
        startPos = 0.2*width;

    if(selector=="states")
    {
        var space = 0.6*width/(numStates+1);
        for(i=0;i<numStates;i++)
        {
          stateData[i].x = startPos + (i+1)*space;
          stateData[i].y = svg.node().getBBox().height + stateHeight*ht;
        }
    }else
    {
      var space = 0.6*width/(numObs+1);
      for(i=0;i<numObs;i++)
      {
        obsData[i].x = startPos + (i+1)*space;
        obsData[i].y = svg.node().getBBox().height + obsHeight*ht;
      }
    }
  }

    function positionLink(d) {

  var startPos = [stateData[d.source].x,stateData[d.source].y],
      endPos = [stateData[d.target].x,stateData[d.target].y];
  var dx = startPos[0]-endPos[0],
    dy = startPos[1]-endPos[1],
    dr = Math.sqrt(dx*dx + dy*dy);

  return "M" + startPos[0]+ "," + startPos[1]
       + "A" + dr + "," + dr + " 0 0,1 "
       + endPos[0] + "," + endPos[1];
}

 function selectTextGen(id)
  {
    if(id.indexOf("state")!=-1)
    {
    //State node
    var text='',
        stateID = id[5];

    for(i=0;i<numStates;i++)
    {
      text = text + "#state"+stateID+i+",";
    }

    for(i=0;i<numObs-1;i++)
    {
      text = text + "#obs"+stateID+i+",";
    }
    text = text + "#obs"+stateID+(numObs-1);

    return text;

    }else
    {
    //Obs node

    }
  }

 function mouseSVGClick(d){
 
      plot.selectAll("path,circle,line").attr("opacity",1.0);
      selected = 0;
   
    
  }
  function mouseCircleClick(d)
  {
    
    if(selected==0)
    {
      selected=1;
      
    plot.selectAll("path,circle,line").attr("opacity",0.1);
    selectText = selectTextGen(this.id);
    
    plot.selectAll(selectText+",#"+this.id).attr("opacity",1.0);
    }else
    {
      mouseSVGClick(d);
    }
    
  }
  function mouseoverCircle()
  {
    d3.select(this).attr("fill","orange").attr("stroke","none");    
    var coords = d3.mouse(this);
    if(this.id.indexOf("state")!=-1)
    {
      var coords = [stateData[this.id[5]].x,stateData[this.id[5]].y];
      var name = stateData[this.id[5]].name;
      var output = "State : "+name;
      var length = 6*(output.length);
      
    }else
    {
      var coords  = [obsData[this.id[3]].x,obsData[this.id[3]].y];
      var name = obsData[this.id[3]].name;
      var output = "Obs : "+name;
      var length = 6*(output.length);
    }
    plot.append("rect").attr("x",coords[0]-length/2).attr("opacity",0.0).attr("fill","black").attr("id","tipRect").attr("width",length).attr("height",30).attr("y",coords[1]+20);
    plot.append("text").attr("x",coords[0]).attr("fill","white").attr("id","tipText").text(output).attr("y",coords[1]+40).attr("font-size",12).attr("text-anchor","middle");
    plot.select("#tipRect").transition().duration(200).attr("opacity",0.7);
  }
  function mouseoutCircle()
  {
    console.log("triggered");
    
    plot.selectAll("#tipRect,#tipText").remove();
    if(this.id.indexOf("state")!=-1)
    {
      d3.select(this).attr("stroke-width",3).attr("stroke","black").attr("fill","white");
      
      
    }else
    {
      d3.select(this).attr("fill","black");
    }
  }
  function dragStart_O(d){
    if(selected==1){return;}
    d3.select(this).attr("opacity",0.5);
  }
  function dragged_O(d){
    if(selected==1){return;}
    var coords = d3.mouse(this);
    obsData[d.id].x = coords[0];
    obsData[d.id].y = coords[1];
    d3.select(this).attr("cx",coords[0]).attr("cy",coords[1]);
    plot.selectAll("line").data(obsLinks).attr("x2",function(d){ return obsData[d.target].x ;}).attr("y2",function(d){ return obsData[d.target].y ;});
    
  }
  function dragEnd_O(d){
    if(selected==1){return;}
    d3.select(this).attr("opacity",1.0);    
    
  }
  function dragStart_S(d){
    if(selected==1){return;}
    d3.select(this).attr("opacity",0.5);
  }
  function dragged_S(d){
    if(selected==1){return;}
    var coords = d3.mouse(this);
    stateData[d.id].x = coords[0];
    stateData[d.id].y = coords[1];
    d3.select(this).attr("cx",coords[0]).attr("cy",coords[1]);
    plot.selectAll("path").data(stateLinks).attr("d",positionLink);
    plot.selectAll("line").data(obsLinks).attr("x1",function(d){ return stateData[d.source].x ;}).attr("y1",function(d){ return stateData[d.source].y ;});
    
  }
  function dragEnd_S(d){
    if(selected==1){return;}
    d3.select(this).attr("opacity",1.0);    
    
  }  
  

function createTable(nrow,ncol,containerName,tableName,width,height,prefix)
{
  var table = document.createElement("table");
  table.id = tableName;
  table.style.borderSpacing = 0;
  table.style.borderCollapse = "collapse";
  table.style.width=width;
  table.style.height = height;

    //Adding rows
  for(var i =0;i<nrow;i++)
  {
    var row = table.insertRow(0);
    row.id = prefix+"row"+i;
  
  if(i%2==0){ row.style.background = "#F3EFEF";} //row color
  else{ row.style.background = "white"; }
  
  
    for(var j =0;j<ncol;j++)
    {
      var col = row.insertCell();
      col.innerHTML = prefix+"Cell "+i+" "+j;
      col.id = prefix+"Cell "+i+" "+j;
    col.align="center";
    col.style.width=80;
    }
  }
  
  // Adding header
  var row = table.insertRow(0);
  row.style.background ="black";
  for(j=0;j<ncol;j++)
  {
  var col = row.insertCell();
      col.innerHTML = prefix+"Head "+i+" "+j;
      col.id = prefix+"Head "+i+" "+j;
    col.align="center";
    col.style.width=80;
    col.style.color  = "white";
    col.style.borderRight="1px white solid";
  }
  col.style.borderRight = "0px white solid";

  
  var divbox = document.getElementById(containerName);
  divbox.appendChild(table);
  
  fillData("seqTable",emissionMat);
}

function createTable2(nrow,ncol,containerName,tableName,width,height,prefix,data,fontsize=12)
{
  var table = document.createElement("table");
  table.id = tableName;
 // table.style.borderSpacing = 20;
  table.style.borderCollapse = "collapse";
  table.style.width=width;
  table.style.height = height;
  table.style.margin = "20px 20px 60px 20px";
  table.style.padding = "0px 30px 0px 0px ";

    //Adding rows
  for(var i =0;i<nrow;i++)
  {
    var row = table.insertRow(0);
    row.id = prefix+"row"+i;
  
  if(i%2==0){ row.style.background = "#F3EFEF";} //row color
  else{ row.style.background = "white"; }
  
  
    for(var j =0;j<ncol+1;j++)
    {
      var col = row.insertCell();
      col.innerHTML = 0.0;
      col.id = prefix+"Cell "+i+" "+j;
    col.align="center";
	col.style.fontSize = fontsize;
    col.style.width=80;
    }
  }
  
  // Adding header
  var row = table.insertRow(0);
  row.style.background ="black";
  for(j=0;j<ncol+1;j++)
  {
  var col = row.insertCell();
      col.innerHTML = '';
      col.id = prefix+"Head "+i+" "+j;
    col.align="center";
    col.style.width=80;
	col.style.fontSize = fontsize;
    col.style.color  = "white";
    col.style.borderRight="1px white solid";
  }
  col.style.borderRight = "0px white solid";
  
  
  var divbox = document.getElementById(containerName);
  divbox.appendChild(table);
  
  fillData(tableName,data);
}

function fillData(tableName,data)
{
	if(tableName=="emissionTable")
	{
		//obs names
		for(i=1;i<numObs+1;i++)
		{
			document.getElementById("emHead "+numStates+" "+i).innerHTML = "O"+obsData[i-1].id;
		}
		
		//state names
		for(i=1;i<numStates+1;i++)
		{
			document.getElementById("emCell "+(numStates-i)+" "+0).innerHTML = "O"+stateData[i-1].id;
		}
		
		//prob values
		for(i=1;i<numStates+1;i++)
		{
			for(j=1;j<numObs+1;j++)
			{
				document.getElementById("emCell "+(numStates-i)+" "+j).innerHTML = data[i-1][j-1].toPrecision(3);
				document.getElementById("emCell "+(numStates-i)+" "+j).id = "emTable"+(i-1)+""+(j-1);
			}
		}
	}else if(tableName=="transitionTable")
	{
	
		//obs names
		for(i=1;i<numStates+1;i++)
		{
			document.getElementById("transHead "+numStates+" "+i).innerHTML = "S"+stateData[i-1].id;
		}
		
		//state names
		for(i=1;i<numStates+1;i++)
		{
			document.getElementById("transCell "+(numStates-i)+" "+0).innerHTML = "S"+stateData[i-1].id;
		}
		
		//prob values
		for(i=1;i<numStates+1;i++)
		{
			for(j=1;j<numStates+1;j++)
			{
				document.getElementById("transCell "+(numStates-i)+" "+j).innerHTML = data[i-1][j-1].toPrecision(3);
				document.getElementById("transCell "+(numStates-i)+" "+j).id = "transTable"+(i-1)+""+(j-1);
			}
		}
	}else
	{
		for(i=1;i<obsLength+1;i++)
		{
			seqTable.rows[0].cells[i].innerHTML = "O"+obsSeq[i-1];
		}
		
		//state names
		for(i=1;i<numStates+1;i++)
		{
			seqTable.rows[i].cells[0].innerHTML = "S"+stateData[i-1].id;
		}
		
		//prob values
		for(i=1;i<numStates+1;i++)
		{
			for(j=1;j<numStates+1;j++)
			{
				seqTable.rows[i].cells[j].innerHTML = 0.0;
			}
		}
	}
	

}


function cleanTable(tableID,prefix)
{
  var table = document.getElementById(tableID),
    nrow = table.rows.length;
  
  document.getElementById(prefix+"Head "+ (nrow-1) + " 0").style.background="white";
  
  for(i=0;i<nrow-1;i++)
  {
    var cell = document.getElementById(prefix+"Cell "+i+" 0");
    cell.style.color = "white";
    cell.style.background = "black";
    cell.style.borderBottom  = "1px white solid";
  }
  cell.style.borderTop  = "0px white solid";
}

function getCenter2(selector)
{
	var startPos = plotWidth*0.1;
	
	if(selector=="states")
	{
	   var space = 0.8*plotWidth/(numStates+1);
	   for(i=0;i<numStates;i++)
	   {
			stateData[i].x = startPos + (i+1)*space;
			stateData[i].y = header.node().getBBox().height + stateHeight*plotHeight;
	   }
	}else
	{
		var space = 0.8*plotWidth/(numObs+1);
	   for(i=0;i<numObs;i++)
	   {
			obsData[i].x = startPos + (i+1)*space;
			obsData[i].y = header.node().getBBox().height + obsHeight*plotHeight;
	   }
	}
}



	
</script>
</body>
</html>
